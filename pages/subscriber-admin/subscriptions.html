<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscriptions - HiveMind AR Admin</title>
  <link rel="stylesheet" href="/styles/hivemind.css">
  <style>
    .admin-layout { display: flex; min-height: 100vh; }
    .admin-sidebar { width: 260px; background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; }
    .admin-sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .admin-sidebar-header h2 { font-size: 1.25rem; margin: 0; }
    .admin-sidebar-header span { font-size: 0.75rem; background: #dc3545; padding: 0.125rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
    .admin-nav { flex: 1; padding: 1rem 0; }
    .admin-nav a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.5rem; color: rgba(255,255,255,0.7); text-decoration: none; transition: all 0.2s; font-size: 0.9rem; }
    .admin-nav a:hover { background: rgba(255,255,255,0.1); color: white; }
    .admin-nav a.active { background: rgba(255,255,255,0.15); color: white; border-left: 3px solid #667eea; }
    .admin-sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
    .admin-sidebar-footer a { color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.875rem; }
    .admin-main { flex: 1; margin-left: 260px; background: var(--hm-light-gray); min-height: 100vh; }
    .admin-header { background: white; padding: 1rem 2rem; border-bottom: 1px solid var(--hm-border); display: flex; justify-content: space-between; align-items: center; }
    .admin-header h1 { font-size: 1.5rem; margin: 0; }
    .admin-content { padding: 2rem; }

    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .stat-card h3 { font-size: 0.875rem; color: var(--hm-text-muted); margin: 0 0 0.5rem 0; }
    .stat-card .value { font-size: 2rem; font-weight: 700; }
    .stat-card.highlight { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .stat-card.highlight h3, .stat-card.highlight .value { color: white; }

    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; margin-bottom: 1.5rem; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--hm-border); display: flex; justify-content: space-between; align-items: center; }
    .card-header h3 { margin: 0; font-size: 1rem; }
    .card-body { padding: 1.5rem; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--hm-border); }
    th { background: var(--hm-light-gray); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; color: var(--hm-text-muted); }

    .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
    .badge-free { background: #e2e8f0; color: #64748b; }
    .badge-basic { background: #dbeafe; color: #1d4ed8; }
    .badge-pro { background: #fef3c7; color: #d97706; }
    .badge-studio { background: #dcfce7; color: #16a34a; }
    .badge-active { background: #dcfce7; color: #16a34a; }
    .badge-cancelled { background: #fee2e2; color: #dc2626; }

    .plan-card { background: white; border-radius: 12px; padding: 1.5rem; border: 2px solid var(--hm-border); }
    .plan-card h4 { margin: 0 0 0.5rem 0; }
    .plan-card .price { font-size: 1.5rem; font-weight: 700; color: var(--hm-dark); }
    .plan-card .details { font-size: 0.875rem; color: var(--hm-text-muted); margin-top: 0.5rem; }

    .mobile-menu-btn { display: none; background: var(--hm-dark); color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.25rem; cursor: pointer; }
    @media (max-width: 768px) {
      .admin-sidebar { transform: translateX(-100%); transition: transform 0.3s; }
      .admin-sidebar.open { transform: translateX(0); }
      .admin-main { margin-left: 0; }
      .mobile-menu-btn { display: block; }
    }
  </style>
</head>
<body>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

  <div class="admin-layout">
    <aside class="admin-sidebar" id="sidebar">
      <div class="admin-sidebar-header">
        <h2>HiveMind AR <span>ADMIN</span></h2>
      </div>
      <nav class="admin-nav">
        <a href="/pages/subscriber-admin/dashboard.html"><span>üìä</span> Dashboard</a>
        <a href="/pages/subscriber-admin/users.html"><span>üë•</span> Users</a>
        <a href="/pages/subscriber-admin/subscriptions.html" class="active"><span>üí≥</span> Subscriptions</a>
        <a href="/pages/subscriber-admin/artworks.html"><span>üñºÔ∏è</span> Artworks</a>
        <a href="/pages/subscriber-admin/messages.html"><span>‚úâÔ∏è</span> Messages</a>
        <a href="/pages/subscriber-admin/analytics.html"><span>üìà</span> Analytics</a>
      </nav>
      <div class="admin-sidebar-footer">
        <a href="/pages/subscriber/dashboard.html">‚Üê Back to User View</a>
      </div>
    </aside>

    <main class="admin-main">
      <header class="admin-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
          <h1>Subscriptions</h1>
        </div>
      </header>

      <div class="admin-content">
        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card">
            <h3>Active Subscriptions</h3>
            <div class="value" id="activeCount">-</div>
          </div>
          <div class="stat-card highlight">
            <h3>Monthly Recurring Revenue</h3>
            <div class="value" id="mrrValue">-</div>
          </div>
          <div class="stat-card">
            <h3>Free Users</h3>
            <div class="value" id="freeCount">-</div>
          </div>
          <div class="stat-card">
            <h3>Churn Rate</h3>
            <div class="value" id="churnRate">-</div>
          </div>
        </div>

        <!-- Plans Overview -->
        <div class="card">
          <div class="card-header">
            <h3>Subscription Plans</h3>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;" id="plansGrid">
              <p style="color: var(--hm-text-muted);">Loading plans...</p>
            </div>
          </div>
        </div>

        <!-- Recent Subscription Activity -->
        <div class="card">
          <div class="card-header">
            <h3>Recent Subscriptions</h3>
          </div>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Plan</th>
                  <th>Status</th>
                  <th>Started</th>
                  <th>PayPal ID</th>
                </tr>
              </thead>
              <tbody id="subscriptionsTable">
                <tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--hm-text-muted);">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { supabase } from '/src/supabase.js';

    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = '/pages/auth/login.html'; return null; }
      return user;
    }

    async function loadStats() {
      // Get all subscriptions with plans
      const { data: subs } = await supabase
        .from('subscriptions')
        .select(`*, subscription_plans (*)`);

      const { data: profiles } = await supabase.from('profiles').select('id');
      const totalUsers = profiles?.length || 0;

      let activeCount = 0;
      let mrr = 0;
      let freeCount = 0;

      subs?.forEach(s => {
        if (s.subscription_plans?.slug === 'free' || !s.subscription_plans) {
          freeCount++;
        } else if (s.status === 'active') {
          activeCount++;
          mrr += parseFloat(s.subscription_plans.price_monthly) || 0;
        }
      });

      // Users without subscription record are free
      freeCount += (totalUsers - (subs?.length || 0));

      document.getElementById('activeCount').textContent = activeCount;
      document.getElementById('mrrValue').textContent = `$${mrr.toFixed(2)}`;
      document.getElementById('freeCount').textContent = freeCount;
      document.getElementById('churnRate').textContent = '0%'; // Would need historical data
    }

    async function loadPlans() {
      const { data: plans } = await supabase
        .from('subscription_plans')
        .select('*')
        .eq('is_active', true)
        .order('price_monthly');

      // Count subscribers per plan
      const { data: subs } = await supabase
        .from('subscriptions')
        .select('plan_id');

      const counts = {};
      subs?.forEach(s => {
        counts[s.plan_id] = (counts[s.plan_id] || 0) + 1;
      });

      const grid = document.getElementById('plansGrid');
      grid.innerHTML = plans?.map(p => `
        <div class="plan-card">
          <h4>${p.name}</h4>
          <div class="price">$${p.price_monthly}/mo</div>
          <div class="details">
            ${p.artwork_limit >= 9999 ? 'Unlimited' : p.artwork_limit} artworks<br>
            <strong>${counts[p.id] || 0}</strong> subscribers
          </div>
        </div>
      `).join('') || '<p>No plans found</p>';
    }

    async function loadSubscriptions() {
      const { data: subs } = await supabase
        .from('subscriptions')
        .select(`
          *,
          subscription_plans (name, slug),
          profiles:user_id (full_name, email)
        `)
        .order('created_at', { ascending: false })
        .limit(20);

      const tbody = document.getElementById('subscriptionsTable');

      if (!subs || subs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--hm-text-muted);">No subscriptions yet</td></tr>';
        return;
      }

      tbody.innerHTML = subs.map(s => {
        const plan = s.subscription_plans || { name: 'Free', slug: 'free' };
        const profile = s.profiles || {};
        return `
          <tr>
            <td>${profile.full_name || profile.email || 'Unknown'}</td>
            <td><span class="badge badge-${plan.slug}">${plan.name}</span></td>
            <td><span class="badge badge-${s.status}">${s.status}</span></td>
            <td>${new Date(s.created_at).toLocaleDateString()}</td>
            <td style="font-family: monospace; font-size: 0.8rem;">${s.paypal_subscription_id || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('active'); };
    window.closeSidebar = function() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobileOverlay').classList.remove('active'); };

    async function init() {
      if (!await checkAuth()) return;
      await Promise.all([loadStats(), loadPlans(), loadSubscriptions()]);
    }
    init();
  </script>
</body>
</html>
