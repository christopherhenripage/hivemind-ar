<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - HiveMind AR</title>
  <link rel="stylesheet" href="/styles/hivemind.css">
  <style>
    .mobile-menu-btn { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 101; background: var(--hm-dark); color: white; border: none; width: 40px; height: 40px; border-radius: 8px; font-size: 1.25rem; cursor: pointer; }
    @media (max-width: 768px) {
      .mobile-menu-btn { display: block; }
      .breadcrumb, .page-header { padding-left: 4rem; }
    }

    .messages-container { display: grid; grid-template-columns: 350px 1fr; gap: 1.5rem; min-height: 500px; }
    @media (max-width: 900px) {
      .messages-container { grid-template-columns: 1fr; }
      .message-detail { display: none; }
      .message-detail.active { display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 200; background: white; overflow-y: auto; }
    }

    .messages-list { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
    .messages-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--hm-border); display: flex; justify-content: space-between; align-items: center; }
    .messages-header h3 { margin: 0; font-size: 1rem; }
    .messages-scroll { max-height: 500px; overflow-y: auto; }

    .message-item { padding: 1rem 1.5rem; border-bottom: 1px solid var(--hm-border); cursor: pointer; transition: background 0.2s; }
    .message-item:hover { background: #fafafa; }
    .message-item.active { background: #f0f9ff; border-left: 3px solid #667eea; }
    .message-item.unread { font-weight: 500; }
    .message-item.unread .message-from::before { content: ''; display: inline-block; width: 8px; height: 8px; background: #667eea; border-radius: 50%; margin-right: 0.5rem; }
    .message-from { font-size: 0.95rem; margin-bottom: 0.25rem; }
    .message-preview { font-size: 0.85rem; color: var(--hm-text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .message-time { font-size: 0.75rem; color: var(--hm-text-muted); margin-top: 0.25rem; }

    .message-detail { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .message-detail-header { padding: 1.5rem; border-bottom: 1px solid var(--hm-border); }
    .message-detail-header h2 { margin: 0 0 0.5rem 0; font-size: 1.25rem; }
    .message-meta { font-size: 0.875rem; color: var(--hm-text-muted); }
    .message-body { padding: 1.5rem; line-height: 1.7; white-space: pre-wrap; }
    .message-artwork { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--hm-light-gray); border-radius: 8px; margin: 1rem 1.5rem; }
    .message-artwork img { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; }
    .message-artwork-info h4 { margin: 0 0 0.25rem 0; font-size: 0.9rem; }
    .message-artwork-info p { margin: 0; font-size: 0.8rem; color: var(--hm-text-muted); }

    .reply-section { padding: 1.5rem; border-top: 1px solid var(--hm-border); }
    .reply-section h4 { margin: 0 0 0.75rem 0; font-size: 0.9rem; }

    .empty-state { text-align: center; padding: 3rem; color: var(--hm-text-muted); }
    .back-btn { display: none; margin: 1rem; }
    @media (max-width: 900px) { .back-btn { display: inline-block; } }
  </style>
</head>
<body>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="https://media.hivemindar.com/images/common/mini_hivemind_logo_white.png" alt="HiveMind" class="logo-icon" style="height: 32px;">
        <span class="logo-text">HiveMind AR</span>
      </div>
      <nav class="sidebar-nav">
        <a href="/pages/subscriber/dashboard.html"><span class="nav-icon">üìä</span><span class="nav-text">Dashboard</span></a>
        <a href="/pages/subscriber/images.html"><span class="nav-icon">üñºÔ∏è</span><span class="nav-text">My Artworks</span></a>
        <a href="/pages/subscriber/profile.html"><span class="nav-icon">üë§</span><span class="nav-text">Profile</span></a>
        <a href="/pages/subscriber/messages.html" class="active"><span class="nav-icon">‚úâÔ∏è</span><span class="nav-text">Messages</span></a>
        <a href="/pages/subscriber/upgrade.html"><span class="nav-icon">‚≠ê</span><span class="nav-text">Upgrade Plan</span></a>
        <a href="/pages/subscriber/support.html"><span class="nav-icon">üéß</span><span class="nav-text">Support</span></a>
      </nav>
      <div class="sidebar-footer">
        <a href="#" onclick="handleLogout()"><span class="nav-icon">üö™</span><span class="nav-text">Sign Out</span></a>
      </div>
    </aside>

    <main class="main-content">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

      <div class="breadcrumb">
        <a href="/pages/subscriber/dashboard.html">Dashboard</a> / <span>Messages</span>
      </div>

      <div class="page-header">
        <h1>Collector Inquiries</h1>
      </div>

      <div class="page-content">
        <div class="messages-container">
          <div class="messages-list">
            <div class="messages-header">
              <h3>Inbox</h3>
              <span id="messageCount" style="font-size: 0.8rem; color: var(--hm-text-muted);"></span>
            </div>
            <div class="messages-scroll" id="messagesList">
              <div class="empty-state">Loading messages...</div>
            </div>
          </div>

          <div class="message-detail" id="messageDetail">
            <div class="empty-state">
              <p>Select a message to view</p>
            </div>
          </div>
        </div>
      </div>

      <footer class="dashboard-footer">&copy; 2026 HiveMind AR</footer>
    </main>
  </div>

  <script type="module">
    import { supabase } from '/src/supabase.js';

    let currentUser = null;
    let messages = [];
    let selectedMessageId = null;

    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href = '/pages/auth/login.html'; return null; }
      return user;
    }

    async function loadMessages() {
      const { data, error } = await supabase
        .from('messages')
        .select(`*, artworks (id, title, thumbnail_url, image_url)`)
        .eq('artist_id', currentUser.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messagesList').innerHTML = '<div class="empty-state">Error loading messages</div>';
        return;
      }

      messages = data || [];
      document.getElementById('messageCount').textContent = `${messages.length} messages`;
      renderMessagesList();
    }

    function renderMessagesList() {
      const list = document.getElementById('messagesList');

      if (messages.length === 0) {
        list.innerHTML = '<div class="empty-state">No messages yet.<br><br>When collectors inquire about your artwork, their messages will appear here.</div>';
        return;
      }

      list.innerHTML = messages.map(m => `
        <div class="message-item ${!m.read ? 'unread' : ''} ${m.id === selectedMessageId ? 'active' : ''}" onclick="selectMessage('${m.id}')">
          <div class="message-from">${escapeHtml(m.sender_name || 'Anonymous')}</div>
          <div class="message-preview">${escapeHtml(m.message?.substring(0, 60) || '')}${m.message?.length > 60 ? '...' : ''}</div>
          <div class="message-time">${formatDate(m.created_at)}</div>
        </div>
      `).join('');
    }

    window.selectMessage = async function(id) {
      const message = messages.find(m => m.id === id);
      if (!message) return;

      selectedMessageId = id;
      renderMessagesList();

      const detail = document.getElementById('messageDetail');
      detail.classList.add('active');

      const artwork = message.artworks;
      const artworkHtml = artwork ? `
        <div class="message-artwork">
          <img src="${artwork.thumbnail_url || artwork.image_url || '/images/placeholder.png'}" alt="${artwork.title}">
          <div class="message-artwork-info">
            <h4>Inquiry about:</h4>
            <p>${escapeHtml(artwork.title)}</p>
          </div>
        </div>
      ` : '';

      detail.innerHTML = `
        <button class="btn btn-light back-btn" onclick="closeDetail()">‚Üê Back to messages</button>
        <div class="message-detail-header">
          <h2>${escapeHtml(message.subject || 'Artwork Inquiry')}</h2>
          <div class="message-meta">
            From: <strong>${escapeHtml(message.sender_name || 'Anonymous')}</strong>
            ${message.sender_email ? `&lt;${escapeHtml(message.sender_email)}&gt;` : ''}<br>
            ${new Date(message.created_at).toLocaleString()}
          </div>
        </div>
        ${artworkHtml}
        <div class="message-body">${escapeHtml(message.message || '')}</div>
        <div class="reply-section">
          <h4>Reply via Email</h4>
          ${message.sender_email
            ? `<a href="mailto:${message.sender_email}?subject=Re: ${encodeURIComponent(message.subject || 'Your Inquiry')}" class="btn btn-dark">Send Email Reply</a>`
            : '<p style="color: var(--hm-text-muted); font-size: 0.875rem;">No email provided by sender</p>'
          }
        </div>
      `;

      // Mark as read
      if (!message.read) {
        await supabase.from('messages').update({ read: true }).eq('id', id);
        message.read = true;
        renderMessagesList();
      }
    };

    window.closeDetail = function() {
      document.getElementById('messageDetail').classList.remove('active');
      selectedMessageId = null;
      renderMessagesList();
    };

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
      return date.toLocaleDateString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    window.handleLogout = async function() { await supabase.auth.signOut(); window.location.href = '/pages/auth/login.html'; };
    window.toggleSidebar = function() { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('mobileOverlay').classList.toggle('active'); };
    window.closeSidebar = function() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('mobileOverlay').classList.remove('active'); };

    async function init() {
      currentUser = await checkAuth();
      if (!currentUser) return;
      await loadMessages();
    }
    init();
  </script>
</body>
</html>
