<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/images/brand/HMC_Logo_AR.png">
  <title>My Artworks - HiveMind AR</title>
  <link rel="stylesheet" href="/styles/hivemind.css">
</head>
<body>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <a href="/" class="sidebar-header" style="text-decoration: none; color: inherit;">
        <img src="https://media.hivemindar.com/images/common/mini_hivemind_logo_white.png" alt="HiveMind" class="logo-icon" style="height: 32px;">
        <span class="logo-text">HiveMind AR</span>
      </a>

      <nav class="sidebar-nav">
        <a href="/pages/subscriber/dashboard.html">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="/pages/subscriber/images.html" class="active">
          <span class="nav-icon">üñºÔ∏è</span>
          <span class="nav-text">My Artworks</span>
        </a>
        <a href="/pages/subscriber/analytics.html">
          <span class="nav-icon">üìà</span>
          <span class="nav-text">Analytics</span>
        </a>
        <a href="/pages/subscriber/profile.html">
          <span class="nav-icon">üë§</span>
          <span class="nav-text">Profile</span>
        </a>
        <a href="/pages/subscriber/messages.html">
          <span class="nav-icon">‚úâÔ∏è</span>
          <span class="nav-text">Messages</span>
        </a>
        <a href="/pages/subscriber/upgrade.html">
          <span class="nav-icon">‚≠ê</span>
          <span class="nav-text">Upgrade Plan</span>
        </a>
        <a href="/pages/subscriber/support.html">
          <span class="nav-icon">üéß</span>
          <span class="nav-text">Support</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="#" onclick="handleLogout()">
          <span class="nav-icon">üö™</span>
          <span class="nav-text">Sign Out</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="/pages/subscriber/dashboard.html">Dashboard</a> / <span>My Artworks</span>
      </div>

      <!-- Page Header -->
      <div class="page-header">
        <h1>My Artworks</h1>
      </div>

      <!-- Page Content -->
      <div class="page-content">
        <!-- Subscription Limit Banner -->
        <div id="limitBanner" class="limit-banner" style="display: none; background: var(--hm-light-gray); padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <span id="usageText">0 of 3 artworks used</span>
            <span id="planBadge" style="background: var(--hm-dark); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Free</span>
          </div>
          <a href="/pages/subscriber/upgrade.html" class="btn btn-dark btn-sm" id="upgradeBannerBtn">Upgrade</a>
        </div>

        <div class="data-table-container">
          <div class="data-table-header">
            <a href="/pages/subscriber/images-create.html" class="btn btn-dark" id="addArtworkBtn">Add Artwork</a>
            <span class="data-table-info" id="tableInfo">Showing 0 of 0 items.</span>
          </div>

          <table class="data-table">
            <thead>
              <tr>
                <th style="width: 80px;">Image</th>
                <th>
                  Title
                  <input type="text" placeholder="Filter..." id="filterTitle" oninput="filterTable()">
                </th>
                <th style="width: 100px;">
                  Size (in)
                </th>
                <th>
                  Price USD
                  <input type="text" placeholder="Filter..." id="filterPrice" oninput="filterTable()">
                </th>
                <th>
                  Views
                </th>
                <th>
                  Created
                  <input type="text" placeholder="Filter..." id="filterCreated" oninput="filterTable()">
                </th>
                <th style="width: 120px;">Actions</th>
              </tr>
            </thead>
            <tbody id="imagesTableBody">
              <tr>
                <td colspan="7" class="no-results">Loading...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer -->
      <footer class="dashboard-footer">
        &copy; 2026 HiveMind AR
      </footer>
    </main>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width: 400px; text-align: center;">
      <h2 style="margin-bottom: 1rem;">Delete Artwork?</h2>
      <p style="color: var(--hm-text-muted); margin-bottom: 1.5rem;">This action cannot be undone. The artwork and its AR model will be permanently deleted.</p>
      <div style="display: flex; gap: 1rem; justify-content: center;">
        <button class="btn btn-light" onclick="hideDeleteModal()">Cancel</button>
        <button class="btn" style="background: var(--hm-danger); color: white;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '/src/supabase.js';

    let allArtworks = [];
    let currentUser = null;
    let userSubscription = null;
    let deleteId = null;

    const INCHES_TO_METERS = 0.0254;

    // Three.js for GLB generation
    let THREE = null;
    let GLTFExporter = null;

    async function loadThreeJS() {
      if (THREE) return true;
      try {
        console.log('Loading Three.js for AR regeneration...');
        THREE = await import('https://esm.sh/three@0.160.0');
        const exporterModule = await import('https://esm.sh/three@0.160.0/examples/jsm/exporters/GLTFExporter.js');
        GLTFExporter = exporterModule.GLTFExporter;
        console.log('Three.js loaded successfully');
        return true;
      } catch (e) {
        console.error('Failed to load Three.js:', e);
        return false;
      }
    }

    // Validate GLB blob
    function validateGLB(blob) {
      if (!blob || blob.size === 0 || blob.size < 100 || blob.size > 50 * 1024 * 1024) {
        return false;
      }
      return true;
    }

    // Generate GLB from image
    async function generateGLB(imageDataUrl, widthInches, heightInches) {
      const loaded = await loadThreeJS();
      if (!loaded) throw new Error('Could not load 3D library');

      const widthMeters = widthInches * INCHES_TO_METERS;
      const heightMeters = heightInches * INCHES_TO_METERS;

      // Load image and create DataTexture
      const textureData = await new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const maxSize = 1024;
          let w = img.width, h = img.height;
          if (w > maxSize || h > maxSize) {
            if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
            else { w = Math.round(w * maxSize / h); h = maxSize; }
          }
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, w, h);
          ctx.translate(0, h);
          ctx.scale(1, -1);
          ctx.drawImage(img, 0, 0, w, h);
          const imageData = ctx.getImageData(0, 0, w, h);
          resolve({ data: imageData.data, width: w, height: h });
        };
        img.onerror = () => reject(new Error('Failed to load image'));
        img.src = imageDataUrl;
      });

      const texture = new THREE.DataTexture(textureData.data, textureData.width, textureData.height, THREE.RGBAFormat);
      texture.flipY = false;
      texture.needsUpdate = true;

      const scene = new THREE.Scene();
      const geometry = new THREE.PlaneGeometry(widthMeters, heightMeters);
      const material = new THREE.MeshStandardMaterial({ map: texture, side: THREE.FrontSide, metalness: 0, roughness: 1 });
      const mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      scene.add(new THREE.AmbientLight(0xffffff, 1));

      return new Promise((resolve, reject) => {
        const exporter = new GLTFExporter();
        exporter.parse(scene, (glb) => {
          const blob = new Blob([glb], { type: 'model/gltf-binary' });
          resolve(blob);
        }, (error) => reject(new Error('Failed to export 3D model')), { binary: true });
      });
    }

    // Generate GLB with retry
    async function generateGLBWithRetry(imageUrl, widthInches, heightInches, maxRetries = 3) {
      let lastError;
      for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
          const glbBlob = await generateGLB(imageUrl, widthInches, heightInches);
          if (validateGLB(glbBlob)) return glbBlob;
          throw new Error('Generated GLB failed validation');
        } catch (err) {
          lastError = err;
          console.warn(`GLB attempt ${attempt} failed:`, err.message);
          if (attempt < maxRetries) await new Promise(r => setTimeout(r, 1000));
        }
      }
      throw lastError || new Error('GLB generation failed');
    }

    // Toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    // Check authentication
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/pages/auth/login.html';
        return null;
      }
      return user;
    }

    // Load images
    async function loadImages() {
      currentUser = await checkAuth();
      if (!currentUser) return;

      // Get subscription with plan details
      const { data: subscription } = await supabase
        .from('subscriptions')
        .select(`
          *,
          subscription_plans (
            name,
            slug,
            artwork_limit
          )
        `)
        .eq('user_id', currentUser.id)
        .single();

      userSubscription = subscription;

      // Get artworks for this user
      const { data: artworks, error } = await supabase
        .from('artworks')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error('Error loading artworks:', error);
        return;
      }

      allArtworks = artworks || [];

      // Update limit banner
      if (subscription && subscription.subscription_plans) {
        const plan = subscription.subscription_plans;
        const count = allArtworks.length;
        const limit = plan.artwork_limit;

        document.getElementById('usageText').textContent =
          `${count} of ${limit >= 9999 ? '‚àû' : limit} artworks used`;
        document.getElementById('planBadge').textContent = plan.name;
        document.getElementById('limitBanner').style.display = 'flex';

        // Hide upgrade button for unlimited
        if (plan.slug === 'unlimited') {
          document.getElementById('upgradeBannerBtn').style.display = 'none';
        }

        // Disable add artwork if at limit
        if (count >= limit && limit < 9999) {
          const addBtn = document.getElementById('addArtworkBtn');
          addBtn.classList.add('disabled');
          addBtn.style.opacity = '0.5';
          addBtn.style.pointerEvents = 'none';
          addBtn.textContent = 'Limit Reached';
        }
      }

      renderTable(allArtworks);
    }

    function renderTable(artworks) {
      const tbody = document.getElementById('imagesTableBody');
      const info = document.getElementById('tableInfo');

      info.textContent = artworks.length > 0
        ? `Showing 1-${artworks.length} of ${artworks.length} items.`
        : 'No artworks yet.';

      if (artworks.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="no-results">
              No artworks yet. <a href="/pages/subscriber/images-create.html">Add your first artwork</a>
            </td>
          </tr>`;
        return;
      }

      tbody.innerHTML = artworks.map(artwork => `
        <tr>
          <td>
            <img src="${artwork.thumbnail_url || artwork.image_url || '/images/placeholder.png'}"
                 alt="${artwork.title}"
                 class="thumbnail">
          </td>
          <td>
            <strong>${artwork.title}</strong>
            ${artwork.glb_url
              ? '<span class="ar-badge" title="AR Ready">AR</span>'
              : '<span class="ar-badge ar-missing" title="AR model missing - click Regenerate">No AR</span>'}
          </td>
          <td>${artwork.width_inches && artwork.height_inches ? `${artwork.width_inches}" √ó ${artwork.height_inches}"` : '-'}</td>
          <td>${artwork.price_usd ? '$' + artwork.price_usd.toFixed(2) : '-'}</td>
          <td>${(artwork.view_count || 0)} / ${(artwork.ar_view_count || 0)} AR</td>
          <td>${new Date(artwork.created_at).toLocaleDateString()}</td>
          <td class="actions">
            ${!artwork.glb_url && artwork.image_url ? `<button class="action-btn regenerate-btn" title="Regenerate AR Model" onclick="regenerateGLB('${artwork.id}')" id="regen-${artwork.id}">üîÑ</button>` : ''}
            <button class="action-btn" title="View" onclick="viewArtwork('${artwork.id}')">üëÅÔ∏è</button>
            <button class="action-btn" title="Edit" onclick="editArtwork('${artwork.id}')">‚úèÔ∏è</button>
            <button class="action-btn" title="Delete" onclick="showDeleteModal('${artwork.id}')">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    window.filterTable = function() {
      const titleFilter = document.getElementById('filterTitle').value.toLowerCase();
      const priceFilter = document.getElementById('filterPrice').value.toLowerCase();
      const createdFilter = document.getElementById('filterCreated').value.toLowerCase();

      const filtered = allArtworks.filter(a => {
        const matchTitle = !titleFilter || a.title.toLowerCase().includes(titleFilter);
        const matchPrice = !priceFilter || (a.price_usd || 0).toString().includes(priceFilter);
        const matchCreated = !createdFilter ||
          new Date(a.created_at).toLocaleDateString().toLowerCase().includes(createdFilter);
        return matchTitle && matchPrice && matchCreated;
      });

      renderTable(filtered);
    };

    window.viewArtwork = function(id) {
      // Open artwork in public gallery view
      const artwork = allArtworks.find(a => a.id === id);
      if (artwork) {
        window.open(`/pages/gallery/artwork.html?id=${id}`, '_blank');
      }
    };

    window.editArtwork = function(id) {
      window.location.href = '/pages/subscriber/images-create.html?id=' + id;
    };

    window.showDeleteModal = function(id) {
      deleteId = id;
      document.getElementById('deleteModal').classList.add('active');
    };

    window.hideDeleteModal = function() {
      deleteId = null;
      document.getElementById('deleteModal').classList.remove('active');
    };

    window.confirmDelete = async function() {
      if (!deleteId) return;

      // Get artwork to delete associated storage files
      const artwork = allArtworks.find(a => a.id === deleteId);

      const { error } = await supabase
        .from('artworks')
        .delete()
        .eq('id', deleteId);

      if (error) {
        alert('Error deleting artwork: ' + error.message);
        return;
      }

      // Try to delete storage files (non-critical if fails)
      if (artwork) {
        try {
          if (artwork.image_url) {
            const imagePath = artwork.image_url.split('/artworks/')[1];
            if (imagePath) {
              await supabase.storage.from('artworks').remove([imagePath]);
            }
          }
          if (artwork.thumbnail_url) {
            const thumbPath = artwork.thumbnail_url.split('/artworks/')[1];
            if (thumbPath) {
              await supabase.storage.from('artworks').remove([thumbPath]);
            }
          }
          if (artwork.glb_url) {
            const glbPath = artwork.glb_url.split('/artworks/')[1];
            if (glbPath) {
              await supabase.storage.from('artworks').remove([glbPath]);
            }
          }
        } catch (e) {
          console.warn('Could not delete storage files:', e);
        }
      }

      hideDeleteModal();
      loadImages();
    };

    window.regenerateGLB = async function(artworkId) {
      const artwork = allArtworks.find(a => a.id === artworkId);
      if (!artwork) {
        showToast('Artwork not found', 'error');
        return;
      }

      if (!artwork.image_url) {
        showToast('No image available for AR generation', 'error');
        return;
      }

      if (!artwork.width_inches || !artwork.height_inches) {
        showToast('Artwork dimensions required for AR. Please edit the artwork first.', 'error');
        return;
      }

      const btn = document.getElementById(`regen-${artworkId}`);
      if (btn) {
        btn.disabled = true;
        btn.classList.add('spinning');
      }

      showToast('Generating AR model...', 'info');

      try {
        // Fetch the image and convert to data URL
        const response = await fetch(artwork.image_url);
        if (!response.ok) throw new Error('Failed to fetch image');
        const blob = await response.blob();
        const imageDataUrl = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });

        // Generate GLB with retry
        const glbBlob = await generateGLBWithRetry(imageDataUrl, artwork.width_inches, artwork.height_inches, 3);

        // Upload to storage
        const glbPath = `${currentUser.id}/${Date.now()}_model.glb`;
        const { error: uploadError } = await supabase.storage
          .from('artworks')
          .upload(glbPath, glbBlob, {
            cacheControl: '3600',
            contentType: 'model/gltf-binary',
            upsert: false
          });

        if (uploadError) throw uploadError;

        const { data: { publicUrl: glbUrl } } = supabase.storage
          .from('artworks')
          .getPublicUrl(glbPath);

        // Update artwork record
        const { error: updateError } = await supabase
          .from('artworks')
          .update({ glb_url: glbUrl })
          .eq('id', artworkId)
          .eq('user_id', currentUser.id);

        if (updateError) throw updateError;

        showToast('AR model generated successfully!', 'success');
        loadImages(); // Refresh the table

      } catch (err) {
        console.error('AR regeneration failed:', err);
        showToast('Failed to generate AR model: ' + err.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.classList.remove('spinning');
        }
      }
    };

    window.handleLogout = async function() {
      await supabase.auth.signOut();
      window.location.href = '/pages/auth/login.html';
    };

    window.toggleSidebar = function() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('mobileOverlay').classList.toggle('active');
    };

    window.closeSidebar = function() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('mobileOverlay').classList.remove('active');
    };

    loadImages();
  </script>

  <style>
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 8px;
      padding: 2rem;
    }

    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: var(--hm-dark);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      font-size: 1.25rem;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
      .breadcrumb, .page-header {
        padding-left: 4rem;
      }
    }

    .ar-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.5rem;
      vertical-align: middle;
    }

    .ar-badge.ar-missing {
      background: #6c757d;
    }

    .regenerate-btn {
      background: #ffc107 !important;
      border-color: #ffc107 !important;
    }

    .regenerate-btn:hover {
      background: #e0a800 !important;
    }

    .regenerate-btn.spinning {
      animation: spin 1s linear infinite;
      pointer-events: none;
      opacity: 0.7;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      border-radius: 8px;
      color: white;
      font-size: 0.9rem;
      z-index: 10000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      max-width: 350px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .toast-success {
      background: #28a745;
    }

    .toast-error {
      background: #dc3545;
    }

    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
    }

    .limit-banner {
      display: none;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
  </style>
</body>
</html>
