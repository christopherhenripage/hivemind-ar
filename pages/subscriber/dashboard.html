<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - HiveMind AR</title>
  <link rel="stylesheet" href="/styles/hivemind.css">
</head>
<body>
  <div class="mobile-overlay" id="mobileOverlay" onclick="closeSidebar()"></div>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="https://media.hivemindar.com/images/common/mini_hivemind_logo_white.png" alt="HiveMind" class="logo-icon" style="height: 32px;">
        <span class="logo-text">HiveMind AR</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/pages/subscriber/dashboard.html" class="active">
          <span class="nav-icon">üìä</span>
          <span class="nav-text">Dashboard</span>
        </a>
        <a href="/pages/subscriber/images.html">
          <span class="nav-icon">üñºÔ∏è</span>
          <span class="nav-text">My Artworks</span>
        </a>
        <a href="/pages/subscriber/profile.html">
          <span class="nav-icon">üë§</span>
          <span class="nav-text">Profile</span>
        </a>
        <a href="/pages/subscriber/messages.html">
          <span class="nav-icon">‚úâÔ∏è</span>
          <span class="nav-text">Messages</span>
        </a>
        <a href="/pages/subscriber/upgrade.html">
          <span class="nav-icon">‚≠ê</span>
          <span class="nav-text">Upgrade Plan</span>
        </a>
        <a href="/pages/subscriber/support.html">
          <span class="nav-icon">üéß</span>
          <span class="nav-text">Support</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="#" onclick="handleLogout()">
          <span class="nav-icon">üö™</span>
          <span class="nav-text">Sign Out</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="/pages/subscriber/dashboard.html">Dashboard</a>
      </div>

      <!-- Page Header -->
      <div class="page-header">
        <h1>Welcome, <span id="userName">Artist</span></h1>
      </div>

      <!-- Page Content -->
      <div class="page-content">
        <!-- Subscription Banner -->
        <div id="subscriptionBanner" class="subscription-banner" style="display: none; background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.25rem;"><span id="planName">Free</span> Plan</h3>
              <p style="opacity: 0.8; font-size: 0.9rem;"><span id="artworkUsage">0</span> of <span id="artworkLimit">3</span> artworks used</p>
              <p id="brandingNote" style="display: none; opacity: 0.7; font-size: 0.8rem; margin-top: 0.25rem;">Your AR previews include HiveMind branding ¬∑ <a href="/pages/subscriber/upgrade.html" style="color: white; text-decoration: underline;">Upgrade to remove</a></p>
            </div>
            <a href="/pages/subscriber/upgrade.html" class="btn" style="background: white; color: #1a1a1a;" id="upgradeBtn">Upgrade Plan</a>
          </div>
          <div style="margin-top: 1rem; background: rgba(255,255,255,0.2); border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="usageBar" style="background: white; height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
          <div class="stat-card" style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="font-size: 0.875rem; color: var(--hm-text-muted); margin-bottom: 0.5rem;">Total Artworks</h3>
            <div class="value" style="font-size: 2rem; font-weight: 600;" id="totalArtworks">0</div>
          </div>
          <div class="stat-card" style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="font-size: 0.875rem; color: var(--hm-text-muted); margin-bottom: 0.5rem;">Total Views</h3>
            <div class="value" style="font-size: 2rem; font-weight: 600;" id="totalViews">0</div>
          </div>
          <div class="stat-card" style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="font-size: 0.875rem; color: var(--hm-text-muted); margin-bottom: 0.5rem;">AR Views</h3>
            <div class="value" style="font-size: 2rem; font-weight: 600;" id="totalARViews">0</div>
          </div>
          <div class="stat-card" style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h3 style="font-size: 0.875rem; color: var(--hm-text-muted); margin-bottom: 0.5rem;">Messages</h3>
            <div class="value" style="font-size: 2rem; font-weight: 600;" id="totalMessages">0</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
          <h2 style="font-size: 1.25rem; margin-bottom: 1rem;">Quick Actions</h2>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="/pages/subscriber/images.html?action=create" class="btn btn-dark" id="addArtworkBtn">Add New Artwork</a>
            <a href="/pages/subscriber/profile.html" class="btn btn-outline">Edit Profile</a>
            <button class="btn btn-outline" id="viewGalleryBtn" onclick="viewPublicGallery()">View Public Gallery</button>
            <button class="btn btn-outline" onclick="copyGalleryLink()">Copy Gallery Link</button>
          </div>
        </div>

        <!-- Gallery Link -->
        <div id="galleryLinkSection" style="display: none; background: var(--hm-light-gray); padding: 1.5rem; border-radius: 8px; margin-top: 1.5rem;">
          <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">Your Public Gallery</h3>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="galleryLinkInput" readonly style="flex: 1; padding: 0.75rem; border: 1px solid var(--hm-border); border-radius: 4px; font-size: 0.9rem;">
            <button class="btn btn-dark" onclick="copyGalleryLink()">Copy</button>
          </div>
          <p style="font-size: 0.8rem; color: var(--hm-text-muted); margin-top: 0.5rem;">Share this link with collectors to show your gallery with AR viewing</p>
        </div>

        <!-- Recent Artworks -->
        <div style="background: var(--hm-white); padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="font-size: 1.25rem;">Recent Artworks</h2>
            <a href="/pages/subscriber/images.html" style="font-size: 0.9rem; color: var(--hm-text-muted);">View All ‚Üí</a>
          </div>
          <div id="recentArtworks" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem;">
            <p style="color: var(--hm-text-muted);">Loading...</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="dashboard-footer">
        &copy; 2026 HiveMind AR
      </footer>
    </main>
  </div>

  <script type="module">
    import { supabase } from '/src/supabase.js';

    let currentUser = null;
    let userProfile = null;
    let userSubscription = null;

    // Check authentication
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = '/pages/auth/login.html';
        return null;
      }
      return user;
    }

    // Create missing profile and subscription (fallback if trigger failed)
    async function ensureProfileExists(user) {
      // Check if profile exists
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single();

      if (profileError && profileError.code === 'PGRST116') {
        // Profile doesn't exist - create it
        console.log('Creating missing profile for user:', user.id);
        const { error: createError } = await supabase
          .from('profiles')
          .insert({
            id: user.id,
            email: user.email,
            full_name: user.user_metadata?.full_name || '',
            created_at: new Date().toISOString()
          });

        if (createError) {
          console.error('Failed to create profile:', createError);
        }

        // Also create subscription
        const { data: freePlan } = await supabase
          .from('subscription_plans')
          .select('id')
          .eq('slug', 'free')
          .single();

        if (freePlan) {
          await supabase
            .from('subscriptions')
            .insert({
              user_id: user.id,
              plan_id: freePlan.id,
              status: 'active',
              created_at: new Date().toISOString()
            });
        }

        // Fetch the newly created profile
        const { data: newProfile } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', user.id)
          .single();

        return newProfile;
      }

      return profile;
    }

    // Load dashboard data
    async function loadDashboard() {
      currentUser = await checkAuth();
      if (!currentUser) return;

      // Get profile (with auto-creation fallback)
      const profile = await ensureProfileExists(currentUser);

      userProfile = profile;

      if (profile) {
        document.getElementById('userName').textContent = profile.full_name || profile.gallery_name || 'Artist';

        // Set gallery link
        if (profile.gallery_slug) {
          const galleryUrl = `${window.location.origin}/pages/gallery/artist.html?slug=${profile.gallery_slug}`;
          document.getElementById('galleryLinkInput').value = galleryUrl;
          document.getElementById('galleryLinkSection').style.display = 'block';
          window.gallerySlug = profile.gallery_slug;
        }
      }

      // Get subscription with plan details
      const { data: subscription } = await supabase
        .from('subscriptions')
        .select(`
          *,
          subscription_plans (
            name,
            slug,
            artwork_limit
          )
        `)
        .eq('user_id', currentUser.id)
        .single();

      userSubscription = subscription;

      // Get artwork count
      const { count: artworkCount } = await supabase
        .from('artworks')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', currentUser.id);

      const totalArtworks = artworkCount || 0;
      document.getElementById('totalArtworks').textContent = totalArtworks;

      // Update subscription banner
      if (subscription && subscription.subscription_plans) {
        const plan = subscription.subscription_plans;
        document.getElementById('planName').textContent = plan.name;
        document.getElementById('artworkUsage').textContent = totalArtworks;
        document.getElementById('artworkLimit').textContent = plan.artwork_limit >= 9999 ? '‚àû' : plan.artwork_limit;
        document.getElementById('subscriptionBanner').style.display = 'block';

        // Usage bar
        const usagePercent = plan.artwork_limit >= 9999 ? 10 : Math.min((totalArtworks / plan.artwork_limit) * 100, 100);
        document.getElementById('usageBar').style.width = usagePercent + '%';

        // Hide upgrade button for unlimited
        if (plan.slug === 'unlimited') {
          document.getElementById('upgradeBtn').style.display = 'none';
        }

        // Show branding note for free tier
        if (plan.slug === 'free') {
          document.getElementById('brandingNote').style.display = 'block';
        }

        // Disable add artwork if at limit
        if (totalArtworks >= plan.artwork_limit && plan.artwork_limit < 9999) {
          document.getElementById('addArtworkBtn').classList.add('disabled');
          document.getElementById('addArtworkBtn').style.opacity = '0.5';
          document.getElementById('addArtworkBtn').style.pointerEvents = 'none';
        }
      }

      // Get total views
      const { data: artworks } = await supabase
        .from('artworks')
        .select('view_count, ar_view_count')
        .eq('user_id', currentUser.id);

      const totalViews = artworks?.reduce((sum, a) => sum + (a.view_count || 0), 0) || 0;
      const totalARViews = artworks?.reduce((sum, a) => sum + (a.ar_view_count || 0), 0) || 0;
      document.getElementById('totalViews').textContent = totalViews;
      document.getElementById('totalARViews').textContent = totalARViews;

      // Get message count
      const { count: messageCount } = await supabase
        .from('messages')
        .select('*', { count: 'exact', head: true })
        .eq('artist_id', currentUser.id);

      document.getElementById('totalMessages').textContent = messageCount || 0;

      // Load recent artworks
      const { data: recentArtworks } = await supabase
        .from('artworks')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at', { ascending: false })
        .limit(4);

      const container = document.getElementById('recentArtworks');

      if (recentArtworks && recentArtworks.length > 0) {
        container.innerHTML = recentArtworks.map(artwork => `
          <a href="/pages/subscriber/images.html?edit=${artwork.id}" style="text-decoration: none; color: inherit;">
            <div style="background: var(--hm-light-gray); border-radius: 8px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
              <img src="${artwork.thumbnail_url || artwork.image_url || '/images/placeholder.png'}"
                   alt="${artwork.title}"
                   style="width: 100%; aspect-ratio: 1; object-fit: cover;">
              <div style="padding: 0.75rem;">
                <h4 style="font-size: 0.875rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${artwork.title}</h4>
                <p style="font-size: 0.75rem; color: var(--hm-text-muted);">${artwork.price_usd ? '$' + artwork.price_usd : 'No price'}</p>
              </div>
            </div>
          </a>
        `).join('');
      } else {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--hm-text-muted);">
            <p>No artworks yet.</p>
            <a href="/pages/subscriber/images.html?action=create" class="btn btn-dark" style="margin-top: 1rem;">Add Your First Artwork</a>
          </div>
        `;
      }
    }

    window.viewPublicGallery = function() {
      if (window.gallerySlug) {
        window.open(`/pages/gallery/artist.html?slug=${window.gallerySlug}`, '_blank');
      } else {
        alert('Please set up your gallery slug in your profile first.');
        window.location.href = '/pages/subscriber/profile.html';
      }
    };

    window.copyGalleryLink = function() {
      const input = document.getElementById('galleryLinkInput');
      if (input.value) {
        navigator.clipboard.writeText(input.value).then(() => {
          alert('Gallery link copied to clipboard!');
        }).catch(() => {
          input.select();
          document.execCommand('copy');
          alert('Gallery link copied!');
        });
      } else {
        alert('Please set up your gallery slug in your profile first.');
      }
    };

    window.handleLogout = async function() {
      await supabase.auth.signOut();
      window.location.href = '/pages/auth/login.html';
    };

    // Mobile sidebar
    window.toggleSidebar = function() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('mobileOverlay').classList.toggle('active');
    };

    window.closeSidebar = function() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('mobileOverlay').classList.remove('active');
    };

    // Initialize
    loadDashboard();
  </script>

  <style>
    .mobile-menu-btn {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 101;
      background: var(--hm-dark);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      font-size: 1.25rem;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .mobile-menu-btn {
        display: block;
      }
      .breadcrumb, .page-header {
        padding-left: 4rem;
      }
    }

    .stats-grid .stat-card {
      border-left: 4px solid var(--hm-dark);
    }

    .sidebar-nav a.active {
      background: rgba(255,255,255,0.15);
      color: white;
    }
  </style>
</body>
</html>
